<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="index.css">
</head>

<body>
  <video id="videoInput" controls playsinline muted autoplay></video>
  <canvas id="canvasOutput"></canvas>
  <script async src="https://docs.opencv.org/4.5.1/opencv.js" onload="onOpenCvScriptLoad();"
    type="text/javascript"></script>
  <script>
    let video = document.getElementById('videoInput');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(function (stream) {
        video.srcObject = stream;
        video.play();
      })
      .catch(function (err) {
        console.log(err.name + ": " + err.message);
      });
    let src, dst, gray, cap, faces, classifier; // cv変数の宣言


    function onOpenCvScriptLoad() {
      cv.onRuntimeInitialized = onOpenCvReady;
    }

    function onOpenCvReady() {
      // OpenCV が読み込まれているか確認
      if (typeof cv == 'undefined') {
        setTimeout(onOpenCvReady, 50);
        return;
      }

      video.oncanplay = function () {
        video.width = video.videoWidth;
        video.height = video.videoHeight;
        // OpenCVが読み込まれたらこの関数が呼ばれる
        // 初期化
        cv = window.cv || global.cv; // cv変数をグローバルスコープに定義
        if (cv.getBuildInformation) {
          console.log(cv.getBuildInformation());
        }

        src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        dst = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        gray = new cv.Mat();
        cap = new cv.VideoCapture(video);
        faces = new cv.RectVector();
        classifier = new cv.CascadeClassifier();

        // load pre-trained classifiers
        // ここまでのパスを取得
        classifier.load('haarcascade_frontalface_default.xml');

        // その他の初期化コードをここに移動できます

        // schedule the first one.
        setTimeout(processVideo, 0);
      };
    }

    const FPS = 30;
    const streaming = true;
    function processVideo() {
      try {
        if (!streaming) {
          // clean and stop.
          src.delete();
          dst.delete();
          gray.delete();
          faces.delete();
          classifier.delete();
          return;
        }
        let begin = Date.now();
        // start processing.
        cap.read(src);
        src.copyTo(dst);
        cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);
        // detect faces.
        console.log("ここまで動く");
        classifier.detectMultiScale(gray, faces, 1.1, 3, 0);

        // draw faces.
        for (let i = 0; i < faces.size(); ++i) {
          let face = faces.get(i);
          let point1 = new cv.Point(face.x, face.y);
          let point2 = new cv.Point(face.x + face.width, face.y + face.height);
          cv.rectangle(dst, point1, point2, [255, 0, 0, 255]);
        }
        cv.imshow('canvasOutput', dst);
        // schedule the next one.
        let delay = 1000 / FPS - (Date.now() - begin);
        console.log(delay);
        setTimeout(processVideo, delay);
      } catch (err) {
        console.error(err);
      }
    };
  </script>
</body>

</html>